<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mehfil - Boston Events</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --navy: #1e3a5f;
            --harbor-blue: #2c5282;
            --sky-blue: #4299e1;
            --light-blue: #ebf8ff;
            --brick: #c53030;
            --warm-red: #e53e3e;
            --gold: #d69e2e;
            --cream: #fffaf0;
            --gray-50: #f7fafc;
            --gray-100: #edf2f7;
            --gray-200: #e2e8f0;
            --gray-600: #718096;
            --gray-800: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background: var(--gray-50);
            color: var(--gray-800);
            line-height: 1.6;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--harbor-blue) 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .brand-icon {
            width: 40px;
            height: 40px;
            background: var(--gold);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .brand h1 {
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .brand p {
            font-size: 0.85rem;
            opacity: 0.85;
            margin-top: 2px;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        .header-btn {
            padding: 0.6rem 1.25rem;
            border: 2px solid rgba(255,255,255,0.3);
            background: transparent;
            color: white;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.5);
        }

        /* Main Layout */
        .app-container {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid var(--gray-200);
            padding: 1.5rem;
            overflow-y: auto;
            position: sticky;
            top: 0;
            height: calc(100vh - 80px);
        }

        .sidebar-section {
            margin-bottom: 1.75rem;
        }

        .sidebar-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-600);
            margin-bottom: 0.75rem;
        }

        /* Search */
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--harbor-blue);
            box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.1);
        }

        /* Date Range */
        .date-range {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .date-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .date-label {
            font-size: 0.85rem;
            color: var(--gray-600);
            min-width: 40px;
        }

        .date-input {
            flex: 1;
            padding: 0.6rem 0.75rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--harbor-blue);
        }

        .date-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.5rem;
        }

        .date-preset {
            padding: 0.4rem 0.75rem;
            border: 1px solid var(--gray-200);
            background: white;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-preset:hover {
            border-color: var(--harbor-blue);
            color: var(--harbor-blue);
        }

        .date-preset.active {
            background: var(--navy);
            color: white;
            border-color: var(--navy);
        }

        /* Filter Chips */
        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .filter-chip {
            padding: 0.5rem 0.9rem;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .filter-chip:hover {
            border-color: var(--harbor-blue);
        }

        .filter-chip.active {
            background: var(--navy);
            color: white;
            border-color: var(--navy);
        }

        .filter-chip.active .chip-dot {
            background: white !important;
        }

        /* Calendar Export Dropdown */
        .calendar-dropdown {
            position: relative;
            display: inline-block;
        }

        .calendar-btn {
            padding: 0.4rem 0.75rem;
            background: var(--light-blue);
            color: var(--harbor-blue);
            border: 1px solid var(--harbor-blue);
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.2s;
        }

        .calendar-btn:hover {
            background: var(--harbor-blue);
            color: white;
        }

        .calendar-menu {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
            min-width: 160px;
            margin-bottom: 0.5rem;
        }

        .calendar-menu.show {
            display: block;
        }

        .calendar-menu-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            font-size: 0.85rem;
            color: var(--gray-800);
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
        }

        .calendar-menu-item:hover {
            background: var(--light-blue);
        }

        .calendar-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .calendar-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .chip-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Toggle Switch */
        .toggle-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle-label {
            font-size: 0.9rem;
            color: var(--gray-800);
        }

        .toggle {
            width: 44px;
            height: 24px;
            background: var(--gray-200);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle.active {
            background: var(--harbor-blue);
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .toggle.active::after {
            left: 22px;
        }

        /* Location Select */
        .location-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 0.95rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .location-select:focus {
            outline: none;
            border-color: var(--harbor-blue);
            box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.1);
        }

        .location-select optgroup {
            font-weight: 600;
            color: var(--navy);
        }

        .location-select option {
            padding: 0.5rem;
        }

        /* Hidden Events */
        .hidden-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--light-blue);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .hidden-info button {
            padding: 0.4rem 0.75rem;
            background: var(--harbor-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 1.5rem 2rem;
            overflow-y: auto;
        }

        /* View Tabs */
        .view-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 0;
        }

        .view-tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .view-tab:hover {
            color: var(--harbor-blue);
        }

        .view-tab.active {
            color: var(--navy);
            border-bottom-color: var(--navy);
        }

        /* Results Header */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .results-count {
            font-size: 0.95rem;
            color: var(--gray-600);
        }

        .results-count strong {
            color: var(--gray-800);
        }

        .sort-select {
            padding: 0.5rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
        }

        /* View Containers */
        .view-container {
            display: none;
        }

        .view-container.active {
            display: block;
        }

        /* Events Grid */
        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.25rem;
        }

        .event-card-link {
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .event-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--gray-200);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .event-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            border-color: var(--harbor-blue);
        }

        .event-card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .event-date {
            text-align: center;
            min-width: 50px;
        }

        .event-date-day {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--navy);
            line-height: 1;
        }

        .event-date-month {
            font-size: 0.75rem;
            color: var(--gray-600);
            text-transform: uppercase;
            font-weight: 500;
        }

        .event-info {
            flex: 1;
            margin-left: 1rem;
        }

        .event-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .event-time {
            font-size: 0.85rem;
            color: var(--gray-600);
        }

        .event-card-body {
            padding: 1rem 1.25rem;
        }

        .event-location {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        .event-location-icon {
            color: var(--brick);
            font-size: 1rem;
        }

        .event-card-footer {
            padding: 0.75rem 1.25rem;
            background: var(--gray-50);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-tags {
            display: flex;
            gap: 0.4rem;
        }

        .event-tag {
            padding: 0.25rem 0.6rem;
            background: var(--light-blue);
            color: var(--harbor-blue);
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .event-price {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .event-price.free {
            color: #059669;
        }

        .event-price.paid {
            color: var(--brick);
        }

        .hide-event-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 28px;
            height: 28px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .event-card:hover .hide-event-btn {
            opacity: 1;
        }

        .hide-event-btn:hover {
            background: #fee2e2;
            border-color: var(--brick);
        }

        /* Calendar View */
        .calendar-container {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            overflow: hidden;
        }

        .calendar-day {
            border-bottom: 1px solid var(--gray-200);
        }

        .calendar-day:last-child {
            border-bottom: none;
        }

        .calendar-day-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        .calendar-day-num {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--navy);
            min-width: 45px;
        }

        .calendar-day-name {
            font-size: 0.95rem;
            color: var(--gray-600);
        }

        .calendar-events {
            padding: 0.5rem 0;
        }

        .calendar-event-link {
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .calendar-event-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .calendar-event-item:hover {
            background: var(--light-blue);
        }

        .calendar-event-time {
            min-width: 80px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--harbor-blue);
        }

        .calendar-event-title {
            flex: 1;
            font-size: 0.95rem;
            color: var(--gray-800);
        }

        .calendar-event-location {
            font-size: 0.85rem;
            color: var(--gray-600);
            max-width: 200px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        .calendar-event-tag {
            padding: 0.2rem 0.5rem;
            background: var(--light-blue);
            color: var(--harbor-blue);
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            margin-left: 0.75rem;
        }

        /* Map View */
        .map-container {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            overflow: hidden;
        }

        #map {
            height: 550px;
        }

        .map-legend {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .legend-item:hover {
            border-color: var(--harbor-blue);
        }

        .legend-item.active {
            background: var(--navy);
            color: white;
            border-color: var(--navy);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* No Results */
        .no-results {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-600);
        }

        .no-results h3 {
            font-size: 1.25rem;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                border-right: none;
                border-bottom: 1px solid var(--gray-200);
            }

            .events-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            header {
                padding: 1rem;
            }

            .brand h1 {
                font-size: 1.5rem;
            }

            .main-content {
                padding: 1rem;
            }

            .sidebar {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="brand">
            <div class="brand-icon">‚òï</div>
            <div>
                <h1>Mehfil</h1>
                <p>Discover experiences in Boston</p>
            </div>
        </div>
        <div class="header-actions">
            <button class="header-btn" onclick="shareEvents()">Share</button>
        </div>
    </header>

    <div class="app-container">
        <!-- Sidebar Filters -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Search</div>
                <input type="text" class="search-input" id="searchInput" placeholder="Search events...">
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Date Range</div>
                <div class="date-range">
                    <div class="date-input-group">
                        <span class="date-label">From</span>
                        <input type="date" class="date-input" id="dateFrom">
                    </div>
                    <div class="date-input-group">
                        <span class="date-label">To</span>
                        <input type="date" class="date-input" id="dateTo">
                    </div>
                    <div class="date-presets">
                        <button class="date-preset active" data-preset="all">All</button>
                        <button class="date-preset" data-preset="today">Today</button>
                        <button class="date-preset" data-preset="week">This Week</button>
                        <button class="date-preset" data-preset="month">This Month</button>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Categories</div>
                <div class="filter-chips" id="categoryChips">
                    <button class="filter-chip active" data-category="all">All</button>
                    <button class="filter-chip" data-category="Arts & Crafts">
                        <span class="chip-dot" style="background:#e879f9;"></span> Arts
                    </button>
                    <button class="filter-chip" data-category="Music & Dance">
                        <span class="chip-dot" style="background:#f472b6;"></span> Music
                    </button>
                    <button class="filter-chip" data-category="Food & Markets">
                        <span class="chip-dot" style="background:#60a5fa;"></span> Food
                    </button>
                    <button class="filter-chip" data-category="Cultural Festival">
                        <span class="chip-dot" style="background:#fbbf24;"></span> Culture
                    </button>
                    <button class="filter-chip" data-category="Community">
                        <span class="chip-dot" style="background:#818cf8;"></span> Community
                    </button>
                    <button class="filter-chip" data-category="Sports & Outdoors">
                        <span class="chip-dot" style="background:#34d399;"></span> Sports
                    </button>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Options</div>
                <div class="toggle-group">
                    <div class="toggle-item">
                        <span class="toggle-label">Free events only</span>
                        <div class="toggle" id="freeToggle"></div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Neighborhood</div>
                <select class="location-select" id="locationFilter">
                    <option value="all">All Areas</option>
                    <optgroup label="Boston">
                        <option value="boston">Boston (All)</option>
                        <option value="back bay">Back Bay</option>
                        <option value="beacon hill">Beacon Hill</option>
                        <option value="chinatown">Chinatown</option>
                        <option value="downtown">Downtown</option>
                        <option value="dorchester">Dorchester</option>
                        <option value="east boston">East Boston</option>
                        <option value="fenway">Fenway</option>
                        <option value="jamaica plain">Jamaica Plain</option>
                        <option value="jp">JP</option>
                        <option value="north end">North End</option>
                        <option value="south boston">South Boston</option>
                        <option value="south end">South End</option>
                        <option value="roxbury">Roxbury</option>
                        <option value="allston">Allston</option>
                        <option value="brighton">Brighton</option>
                    </optgroup>
                    <optgroup label="Greater Boston">
                        <option value="arlington">Arlington</option>
                        <option value="brookline">Brookline</option>
                        <option value="cambridge">Cambridge</option>
                        <option value="malden">Malden</option>
                        <option value="medford">Medford</option>
                        <option value="newton">Newton</option>
                        <option value="quincy">Quincy</option>
                        <option value="somerville">Somerville</option>
                        <option value="watertown">Watertown</option>
                        <option value="waltham">Waltham</option>
                    </optgroup>
                </select>
            </div>

            <div class="sidebar-section" id="hiddenSection" style="display:none;">
                <div class="hidden-info">
                    <span><strong id="hiddenCount">0</strong> hidden</span>
                    <button onclick="resetHidden()">Show all</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="view-tabs">
                <button class="view-tab active" data-view="cards">Cards</button>
                <button class="view-tab" data-view="calendar">Calendar</button>
                <button class="view-tab" data-view="map">Map</button>
            </div>

            <div class="results-header">
                <span class="results-count"><strong id="resultsCount">0</strong> events found</span>
                <select class="sort-select" id="sortSelect">
                    <option value="date">Sort by Date</option>
                    <option value="name">Sort by Name</option>
                </select>
            </div>

            <!-- Cards View -->
            <div class="view-container active" id="cardsView">
                <div class="events-grid" id="eventsGrid"></div>
            </div>

            <!-- Calendar View -->
            <div class="view-container" id="calendarView">
                <div class="calendar-container" id="calendarContainer"></div>
            </div>

            <!-- Map View -->
            <div class="view-container" id="mapView">
                <div class="map-container">
                    <div id="map"></div>
                    <div class="map-legend" id="mapLegend">
                        <div class="legend-item active" data-mapcat="all">
                            <span class="legend-dot" style="background:var(--navy);"></span> All
                        </div>
                        <div class="legend-item" data-mapcat="Arts & Crafts">
                            <span class="legend-dot" style="background:#e879f9;"></span> Arts
                        </div>
                        <div class="legend-item" data-mapcat="Music & Dance">
                            <span class="legend-dot" style="background:#f472b6;"></span> Music
                        </div>
                        <div class="legend-item" data-mapcat="Food & Markets">
                            <span class="legend-dot" style="background:#60a5fa;"></span> Food
                        </div>
                        <div class="legend-item" data-mapcat="Cultural Festival">
                            <span class="legend-dot" style="background:#fbbf24;"></span> Culture
                        </div>
                        <div class="legend-item" data-mapcat="Community">
                            <span class="legend-dot" style="background:#818cf8;"></span> Community
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // State
        let allEvents = [];
        let map = null;
        let markers = [];
        let mapInitialized = false;

        let filters = {
            search: '',
            dateFrom: null,
            dateTo: null,
            categories: [], // Changed to array for multi-select
            location: 'all',
            freeOnly: false,
            mapCategory: 'all'
        };

        let hiddenEvents = JSON.parse(localStorage.getItem('mehfilHidden') || '[]');
        let currentView = 'cards';
        let sortBy = 'date';

        const INTERNAL_CATEGORIES = ['South Asian', 'Middle Eastern'];

        const CATEGORY_COLORS = {
            'Arts & Crafts': '#e879f9',
            'Music & Dance': '#f472b6',
            'Food & Markets': '#60a5fa',
            'Cultural Festival': '#fbbf24',
            'Community': '#818cf8',
            'Sports & Outdoors': '#34d399',
            'Talks & Lectures': '#a78bfa',
            'Religious': '#fb923c',
            'Comedy': '#f87171',
            'Theater & Film': '#ec4899',
            'Coffee & Chai': '#84cc16'
        };

        // Initialize
        async function init() {
            await loadEvents();
            setupEventListeners();
            setDefaultDates();
            updateHiddenUI();
        }

        async function loadEvents() {
            try {
                const response = await fetch('events.json');
                const data = await response.json();
                allEvents = (data.events || []).map(e => ({
                    ...e,
                    displayCategories: (e.categories || []).filter(c => !INTERNAL_CATEGORIES.includes(c))
                }));
                render();
            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('eventsGrid').innerHTML =
                    '<div class="no-results"><h3>Unable to load events</h3><p>Please refresh the page</p></div>';
            }
        }

        function setDefaultDates() {
            const today = new Date();
            document.getElementById('dateFrom').value = formatDateInput(today);

            const nextMonth = new Date(today);
            nextMonth.setMonth(nextMonth.getMonth() + 3);
            document.getElementById('dateTo').value = formatDateInput(nextMonth);
        }

        function formatDateInput(date) {
            return date.toISOString().split('T')[0];
        }

        function setupEventListeners() {
            // Search
            document.getElementById('searchInput').addEventListener('input', e => {
                filters.search = e.target.value.toLowerCase();
                render();
            });

            // Date inputs
            document.getElementById('dateFrom').addEventListener('change', e => {
                filters.dateFrom = e.target.value ? new Date(e.target.value + 'T00:00:00') : null;
                clearDatePresets();
                render();
            });

            document.getElementById('dateTo').addEventListener('change', e => {
                filters.dateTo = e.target.value ? new Date(e.target.value + 'T23:59:59') : null;
                clearDatePresets();
                render();
            });

            // Date presets
            document.querySelectorAll('.date-preset').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.date-preset').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    applyDatePreset(btn.dataset.preset);
                });
            });

            // Category chips - multi-select
            document.querySelectorAll('#categoryChips .filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    const category = chip.dataset.category;
                    const allChip = document.querySelector('#categoryChips .filter-chip[data-category="all"]');

                    if (category === 'all') {
                        // Clear all selections
                        document.querySelectorAll('#categoryChips .filter-chip').forEach(c => c.classList.remove('active'));
                        allChip.classList.add('active');
                        filters.categories = [];
                    } else {
                        // Toggle this category
                        allChip.classList.remove('active');
                        chip.classList.toggle('active');

                        if (chip.classList.contains('active')) {
                            if (!filters.categories.includes(category)) {
                                filters.categories.push(category);
                            }
                        } else {
                            filters.categories = filters.categories.filter(c => c !== category);
                        }

                        // If no categories selected, activate "All"
                        if (filters.categories.length === 0) {
                            allChip.classList.add('active');
                        }
                    }
                    render();
                });
            });

            // Free toggle
            document.getElementById('freeToggle').addEventListener('click', function() {
                this.classList.toggle('active');
                filters.freeOnly = this.classList.contains('active');
                render();
            });

            // Location filter
            document.getElementById('locationFilter').addEventListener('change', e => {
                filters.location = e.target.value;
                render();
            });

            // View tabs
            document.querySelectorAll('.view-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentView = tab.dataset.view;

                    document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
                    document.getElementById(currentView + 'View').classList.add('active');

                    if (currentView === 'map') {
                        initMap();
                    }
                    render();
                });
            });

            // Sort
            document.getElementById('sortSelect').addEventListener('change', e => {
                sortBy = e.target.value;
                render();
            });

            // Map legend filters
            document.querySelectorAll('#mapLegend .legend-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('#mapLegend .legend-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    filters.mapCategory = item.dataset.mapcat;
                    updateMapMarkers();
                });
            });
        }

        function clearDatePresets() {
            document.querySelectorAll('.date-preset').forEach(b => b.classList.remove('active'));
        }

        function applyDatePreset(preset) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let from = today;
            let to = new Date(today);

            if (preset === 'all') {
                to.setFullYear(to.getFullYear() + 1);
            } else if (preset === 'today') {
                to = new Date(today);
                to.setHours(23, 59, 59);
            } else if (preset === 'week') {
                to.setDate(to.getDate() + 7);
            } else if (preset === 'month') {
                to.setMonth(to.getMonth() + 1);
            }

            filters.dateFrom = from;
            filters.dateTo = to;
            document.getElementById('dateFrom').value = formatDateInput(from);
            document.getElementById('dateTo').value = formatDateInput(to);
            render();
        }

        function filterEvents() {
            return allEvents.filter(event => {
                // Hidden
                if (hiddenEvents.includes(event.id)) return false;

                // Search
                if (filters.search) {
                    const text = `${event.name} ${event.location || ''} ${event.description || ''}`.toLowerCase();
                    if (!text.includes(filters.search)) return false;
                }

                // Date range
                if (filters.dateFrom || filters.dateTo) {
                    const eventDate = new Date(event.date + 'T00:00:00');
                    if (filters.dateFrom && eventDate < filters.dateFrom) return false;
                    if (filters.dateTo && eventDate > filters.dateTo) return false;
                }

                // Category - multi-select with OR logic
                if (filters.categories.length > 0) {
                    if (!event.categories) return false;
                    const hasMatch = filters.categories.some(cat => event.categories.includes(cat));
                    if (!hasMatch) return false;
                }

                // Free only
                if (filters.freeOnly) {
                    if (!event.price || !event.price.toLowerCase().includes('free')) return false;
                }

                // Location filter
                if (filters.location !== 'all') {
                    const loc = `${event.location || ''} ${event.address || ''}`.toLowerCase();
                    const filterLoc = filters.location.toLowerCase();

                    // Special handling for "boston" to match Boston but not sub-areas
                    if (filterLoc === 'boston') {
                        // Match Boston but exclude specific neighborhoods that are separate options
                        const excludeAreas = ['cambridge', 'somerville', 'brookline', 'newton', 'quincy',
                                             'arlington', 'malden', 'medford', 'watertown', 'waltham'];
                        const hasExcluded = excludeAreas.some(area => loc.includes(area));
                        if (!loc.includes('boston') && !hasExcluded) return false;
                        if (hasExcluded && !loc.includes('boston')) return false;
                    } else if (filterLoc === 'jp') {
                        // JP is shorthand for Jamaica Plain
                        if (!loc.includes('jamaica plain') && !loc.includes(' jp') && !loc.includes('jp,')) return false;
                    } else {
                        if (!loc.includes(filterLoc)) return false;
                    }
                }

                return true;
            }).sort((a, b) => {
                if (sortBy === 'date') {
                    return new Date(a.date) - new Date(b.date);
                } else {
                    return a.name.localeCompare(b.name);
                }
            });
        }

        function render() {
            const filtered = filterEvents();
            document.getElementById('resultsCount').textContent = filtered.length;

            if (currentView === 'cards') {
                renderCards(filtered);
            } else if (currentView === 'calendar') {
                renderCalendar(filtered);
            } else if (currentView === 'map' && mapInitialized) {
                updateMapMarkers();
            }
        }

        function renderCards(events) {
            const grid = document.getElementById('eventsGrid');

            if (events.length === 0) {
                grid.innerHTML = '<div class="no-results"><h3>No events found</h3><p>Try adjusting your filters</p></div>';
                return;
            }

            grid.innerHTML = events.map(event => {
                const date = new Date(event.date + 'T00:00:00');
                const day = date.getDate();
                const month = date.toLocaleDateString('en-US', { month: 'short' }).toUpperCase();
                const isFree = event.price && event.price.toLowerCase().includes('free');
                const cats = event.displayCategories || [];

                return `
                    <a href="${event.url || '#'}" target="_blank" rel="noopener" class="event-card-link">
                        <article class="event-card" data-id="${event.id}">
                            <button class="hide-event-btn" onclick="hideEvent('${event.id}', event)">‚úï</button>
                            <div class="event-card-header">
                                <div class="event-date">
                                    <div class="event-date-day">${day}</div>
                                    <div class="event-date-month">${month}</div>
                                </div>
                                <div class="event-info">
                                    <h3 class="event-title">${event.name}</h3>
                                    <div class="event-time">${event.time || 'Time TBA'}</div>
                                </div>
                            </div>
                            <div class="event-card-body">
                                ${event.location ? `
                                    <div class="event-location">
                                        <span class="event-location-icon">üìç</span>
                                        <span>${event.location}</span>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="event-card-footer">
                                <div class="event-tags">
                                    ${cats.slice(0, 2).map(c => `<span class="event-tag">${c}</span>`).join('')}
                                </div>
                                <div style="display:flex;align-items:center;gap:0.5rem;">
                                    ${event.price ? `<span class="event-price ${isFree ? 'free' : 'paid'}">${event.price}</span>` : ''}
                                    <div class="calendar-dropdown">
                                        <button class="calendar-btn" onclick="toggleCalendarMenu(this, event)" data-event-id="${event.id}">
                                            + Cal
                                        </button>
                                        <div class="calendar-menu" data-menu-for="${event.id}">
                                            <div class="calendar-menu-item" onclick="addToGoogleCalendar('${event.id}', event)">
                                                Google
                                            </div>
                                            <div class="calendar-menu-item" onclick="downloadICS('${event.id}', event)">
                                                Apple / Outlook
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </article>
                    </a>
                `;
            }).join('');

            }

        function renderCalendar(events) {
            const container = document.getElementById('calendarContainer');

            if (events.length === 0) {
                container.innerHTML = '<div class="no-results"><h3>No events found</h3></div>';
                return;
            }

            // Group by date
            const byDate = {};
            events.forEach(e => {
                if (!byDate[e.date]) byDate[e.date] = [];
                byDate[e.date].push(e);
            });

            const sortedDates = Object.keys(byDate).sort();

            container.innerHTML = sortedDates.map(dateStr => {
                const date = new Date(dateStr + 'T00:00:00');
                const dayNum = date.getDate();
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

                return `
                    <div class="calendar-day">
                        <div class="calendar-day-header">
                            <span class="calendar-day-num">${dayNum}</span>
                            <span class="calendar-day-name">${dayName}</span>
                        </div>
                        <div class="calendar-events">
                            ${byDate[dateStr].map(event => {
                                const cats = event.displayCategories || [];
                                return `
                                    <a href="${event.url || '#'}" target="_blank" rel="noopener" class="calendar-event-link">
                                        <div class="calendar-event-item" data-id="${event.id}">
                                            <span class="calendar-event-time">${event.time || 'All day'}</span>
                                            <span class="calendar-event-title">${event.name}</span>
                                            ${event.location ? `<span class="calendar-event-location">üìç ${event.location}</span>` : ''}
                                            ${cats[0] ? `<span class="calendar-event-tag">${cats[0]}</span>` : ''}
                                        </div>
                                    </a>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            }

        function initMap() {
            if (mapInitialized) {
                setTimeout(() => map.invalidateSize(), 100);
                return;
            }

            map = L.map('map').setView([42.3601, -71.0589], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            mapInitialized = true;
            updateMapMarkers();
        }

        function updateMapMarkers() {
            if (!map) return;

            markers.forEach(m => map.removeLayer(m));
            markers = [];

            let events = filterEvents();

            // Apply map category filter
            if (filters.mapCategory !== 'all') {
                events = events.filter(e => e.categories && e.categories.includes(filters.mapCategory));
            }

            events.forEach(event => {
                if (!event.latitude || !event.longitude) return;

                const color = getCategoryColor(event);
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background:${color};width:18px;height:18px;border-radius:50%;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [18, 18],
                    iconAnchor: [9, 9]
                });

                const marker = L.marker([event.latitude, event.longitude], { icon }).addTo(map);

                const date = new Date(event.date + 'T00:00:00');
                const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

                marker.bindPopup(`
                    <div style="min-width:200px;">
                        <h4 style="margin:0 0 0.5rem;font-size:0.95rem;">${event.name}</h4>
                        <p style="margin:0.25rem 0;color:#666;font-size:0.85rem;">
                            <strong>${dateStr}</strong>${event.time ? ' ¬∑ ' + event.time : ''}
                        </p>
                        ${event.location ? `<p style="margin:0.25rem 0;color:#666;font-size:0.85rem;">üìç ${event.location}</p>` : ''}
                        ${event.url ? `<a href="${event.url}" target="_blank" style="color:#2c5282;font-weight:500;font-size:0.85rem;">View Details ‚Üí</a>` : ''}
                    </div>
                `);

                markers.push(marker);
            });

            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function getCategoryColor(event) {
            const cats = event.categories || [];
            for (const cat of cats) {
                if (CATEGORY_COLORS[cat]) return CATEGORY_COLORS[cat];
            }
            return '#818cf8';
        }

        function hideEvent(id, e) {
            e.stopPropagation();
            if (!hiddenEvents.includes(id)) {
                hiddenEvents.push(id);
                localStorage.setItem('mehfilHidden', JSON.stringify(hiddenEvents));
                updateHiddenUI();
                render();
            }
        }

        function resetHidden() {
            hiddenEvents = [];
            localStorage.setItem('mehfilHidden', JSON.stringify(hiddenEvents));
            updateHiddenUI();
            render();
        }

        function updateHiddenUI() {
            const section = document.getElementById('hiddenSection');
            const count = document.getElementById('hiddenCount');

            if (hiddenEvents.length > 0) {
                section.style.display = 'block';
                count.textContent = hiddenEvents.length;
            } else {
                section.style.display = 'none';
            }
        }

        function shareEvents() {
            const text = `Check out Boston events on Mehfil!\n${window.location.href}`;

            if (navigator.share) {
                navigator.share({
                    title: 'Mehfil - Boston Events',
                    text: 'Discover amazing events in Boston',
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Link copied to clipboard!');
                });
            }
        }

        // Calendar export functions
        function getEventById(id) {
            return allEvents.find(e => e.id === id);
        }

        function toggleCalendarMenu(btn, e) {
            e.preventDefault();
            e.stopPropagation();

            const eventId = btn.dataset.eventId;

            // Close all other menus
            document.querySelectorAll('.calendar-menu').forEach(menu => {
                if (menu.dataset.menuFor !== eventId) {
                    menu.classList.remove('show');
                }
            });

            const menu = btn.nextElementSibling;
            menu.classList.toggle('show');
        }

        // Close menus when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.calendar-dropdown')) {
                document.querySelectorAll('.calendar-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        function formatICSDate(dateStr, timeStr) {
            const date = new Date(dateStr + 'T00:00:00');

            if (timeStr && timeStr !== 'Time TBA') {
                // Parse time like "7:00 PM" or "10:30 AM"
                const timeMatch = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                if (timeMatch) {
                    let hours = parseInt(timeMatch[1]);
                    const mins = parseInt(timeMatch[2]);
                    const ampm = timeMatch[3].toUpperCase();

                    if (ampm === 'PM' && hours !== 12) hours += 12;
                    if (ampm === 'AM' && hours === 12) hours = 0;

                    date.setHours(hours, mins, 0, 0);
                }
            }

            // Format as YYYYMMDDTHHMMSS
            const pad = n => String(n).padStart(2, '0');
            return `${date.getFullYear()}${pad(date.getMonth() + 1)}${pad(date.getDate())}T${pad(date.getHours())}${pad(date.getMinutes())}00`;
        }

        function formatICSDateOnly(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const pad = n => String(n).padStart(2, '0');
            return `${date.getFullYear()}${pad(date.getMonth() + 1)}${pad(date.getDate())}`;
        }

        function downloadICS(eventId, e) {
            e.preventDefault();
            e.stopPropagation();

            const event = getEventById(eventId);
            if (!event) return;

            const hasTime = event.time && event.time !== 'Time TBA';
            let startDate, endDate;

            if (hasTime) {
                startDate = formatICSDate(event.date, event.time);
                // End 2 hours after start by default
                const endTime = new Date(event.date + 'T00:00:00');
                const timeMatch = event.time.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                if (timeMatch) {
                    let hours = parseInt(timeMatch[1]);
                    const mins = parseInt(timeMatch[2]);
                    const ampm = timeMatch[3].toUpperCase();
                    if (ampm === 'PM' && hours !== 12) hours += 12;
                    if (ampm === 'AM' && hours === 12) hours = 0;
                    endTime.setHours(hours + 2, mins, 0, 0);
                }
                const pad = n => String(n).padStart(2, '0');
                endDate = `${endTime.getFullYear()}${pad(endTime.getMonth() + 1)}${pad(endTime.getDate())}T${pad(endTime.getHours())}${pad(endTime.getMinutes())}00`;
            } else {
                // All-day event
                startDate = formatICSDateOnly(event.date);
                const nextDay = new Date(event.date + 'T00:00:00');
                nextDay.setDate(nextDay.getDate() + 1);
                const pad = n => String(n).padStart(2, '0');
                endDate = `${nextDay.getFullYear()}${pad(nextDay.getMonth() + 1)}${pad(nextDay.getDate())}`;
            }

            const location = event.location ? event.location + (event.address ? ', ' + event.address : '') : '';
            const description = (event.description || '') + (event.url ? '\\n\\nMore info: ' + event.url : '');

            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Mehfil//Boston Events//EN',
                'BEGIN:VEVENT',
                `UID:${eventId}@mehfil`,
                `DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z`,
                hasTime ? `DTSTART:${startDate}` : `DTSTART;VALUE=DATE:${startDate}`,
                hasTime ? `DTEND:${endDate}` : `DTEND;VALUE=DATE:${endDate}`,
                `SUMMARY:${event.name.replace(/,/g, '\\,')}`,
                location ? `LOCATION:${location.replace(/,/g, '\\,')}` : '',
                description ? `DESCRIPTION:${description.replace(/\n/g, '\\n').replace(/,/g, '\\,')}` : '',
                event.url ? `URL:${event.url}` : '',
                'END:VEVENT',
                'END:VCALENDAR'
            ].filter(line => line).join('\r\n');

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${event.name.replace(/[^a-z0-9]/gi, '_').substring(0, 30)}.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Close menu
            document.querySelectorAll('.calendar-menu').forEach(menu => menu.classList.remove('show'));
        }

        function addToGoogleCalendar(eventId, e) {
            e.preventDefault();
            e.stopPropagation();

            const event = getEventById(eventId);
            if (!event) return;

            const hasTime = event.time && event.time !== 'Time TBA';
            let dates;

            if (hasTime) {
                const start = formatICSDate(event.date, event.time);
                // End 2 hours later
                const endTime = new Date(event.date + 'T00:00:00');
                const timeMatch = event.time.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                if (timeMatch) {
                    let hours = parseInt(timeMatch[1]);
                    const mins = parseInt(timeMatch[2]);
                    const ampm = timeMatch[3].toUpperCase();
                    if (ampm === 'PM' && hours !== 12) hours += 12;
                    if (ampm === 'AM' && hours === 12) hours = 0;
                    endTime.setHours(hours + 2, mins, 0, 0);
                }
                const pad = n => String(n).padStart(2, '0');
                const end = `${endTime.getFullYear()}${pad(endTime.getMonth() + 1)}${pad(endTime.getDate())}T${pad(endTime.getHours())}${pad(endTime.getMinutes())}00`;
                dates = `${start}/${end}`;
            } else {
                // All-day event
                const start = formatICSDateOnly(event.date);
                const nextDay = new Date(event.date + 'T00:00:00');
                nextDay.setDate(nextDay.getDate() + 1);
                const pad = n => String(n).padStart(2, '0');
                const end = `${nextDay.getFullYear()}${pad(nextDay.getMonth() + 1)}${pad(nextDay.getDate())}`;
                dates = `${start}/${end}`;
            }

            const location = event.location ? event.location + (event.address ? ', ' + event.address : '') : '';
            const description = (event.description || '') + (event.url ? '\n\nMore info: ' + event.url : '');

            const params = new URLSearchParams({
                action: 'TEMPLATE',
                text: event.name,
                dates: dates,
                details: description,
                location: location
            });

            window.open(`https://calendar.google.com/calendar/render?${params.toString()}`, '_blank');

            // Close menu
            document.querySelectorAll('.calendar-menu').forEach(menu => menu.classList.remove('show'));
        }

        // Start
        init();
    </script>
</body>
</html>
